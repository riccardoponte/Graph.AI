
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Data Visualizer AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              'brand-bg': '#1a1a1a',
              'brand-surface': '#2a2a2e',
              'brand-border': '#404044',
              'brand-text': '#f0f0f0',
              'brand-text-secondary': '#a0a0a4',
              'brand-primary': '#6366f1',
              'brand-primary-hover': '#4f46e5',
            }
          }
        }
      }
    </script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@18.3.1",
    "react-dom/client": "https://esm.sh/react-dom@18.3.1/client",
    "@google/genai": "https://esm.sh/@google/genai@^1.8.0",
    "react-dom/": "https://esm.sh/react-dom@^19.1.0/",
    "react/": "https://esm.sh/react@^19.1.0/"
  }
}
</script>
  </head>
  <body class="bg-brand-bg text-brand-text">
    <div id="root"></div>
    <script>
      // Simulate process.env for the browser environment as per user request
      window.process = {
        env: {
          API_KEY: 'AIzaSyAUpMnG760HSOV7rah2UwkOajoH3aD4OFs'
        }
      };
    </script>
    <script type="text/babel" data-type="module">
        import React, { useState, useCallback, useEffect, useMemo, useRef } from 'react';
        import ReactDOM from 'react-dom/client';
        import { GoogleGenAI, Type } from "@google/genai";

        const fileToBase64 = (file) => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => {
                    const result = reader.result;
                    const base64String = result.split(',')[1];
                    if (base64String) {
                        resolve(base64String);
                    } else {
                        reject(new Error("Failed to read file as Base64 string."));
                    }
                };
                reader.onerror = (error) => reject(error);
            });
        };

        const ai = new GoogleGenAI({ apiKey: process.env.API_KEY });

        const DATA_EXTRACTION_PROMPT = `You are an expert data analyst. Your task is to analyze the provided image of a chart or table and extract its data into a structured JSON format. You must also identify the primary colors used in the visualization.

The output MUST be a single JSON object that strictly adheres to the provided JSON schema. Do not add any extra text, explanations, or markdown formatting around the JSON.`;

        const DATA_EXTRACTION_SCHEMA = {
          type: Type.OBJECT,
          properties: {
            title: { type: Type.STRING, description: 'The main title of the chart or table.' },
            chartType: { type: Type.STRING, description: 'Type of visualization (e.g., "bar", "line", "pie", "table").' },
            data: {
              type: Type.ARRAY,
              description: 'The data points for the visualization. For tables, this will be an array of row arrays.',
              items: {
                type: Type.OBJECT,
                description: 'A single data point or row.',
                properties: {
                  label: { type: Type.STRING, description: 'The label for this data point (e.g., an x-axis category or a row identifier).' },
                  values: {
                    type: Type.ARRAY,
                    description: 'The numerical values associated with this label. Usually one value, but can be more for grouped charts.',
                    items: { type: Type.NUMBER }
                  }
                }
              }
            },
            seriesLabels: {
              type: Type.ARRAY,
              description: 'Labels for the data series, if more than one. E.g., ["Sales 2023", "Sales 2024"]',
              items: { type: Type.STRING }
            },
            colors: {
              type: Type.ARRAY,
              description: 'An array of dominant hex color codes found in the chart\'s data elements (bars, lines, pie slices). Example: ["#34D399", "#A78BFA"]',
              items: { type: Type.STRING }
            }
          },
          required: ["title", "chartType", "data", "colors"]
        };

        const HTML_GENERATION_PROMPT = `**ROLE**: You are an expert web developer specializing in creating beautiful, interactive data visualizations with HTML, CSS, and JavaScript.

**TASK**: Generate a single, self-contained HTML file that visualizes the data provided in the user's message.

**INPUT**: The user will provide a JSON object containing:
1.  \`data\`: The structured data for the visualization (e.g., chart data, table rows).
2.  \`colors\`: A color palette to be used for the visualization elements.
3.  \`chartType\`: The type of chart to create.
4.  \`title\`: The title for the visualization.
5.  (Optional) An image of the original chart for layout and style reference.

**REQUIREMENTS**:
- Create an interactive visualization (e.g., with hover tooltips) using the provided \`data\`.
- The visualization type must match the \`chartType\`.
- **Strictly use the colors from the \`colors\` array for the data elements (bars, lines, pie slices, etc.).**
- The generated code must be a single HTML file with embedded \`<style>\` and \`<script>\` tags. Use a modern, clean, and professional design.
- Use CDN-hosted libraries like Chart.js or D3.js if necessary for the visualization.
- The output must be **only the HTML code**. Start directly with \`<!DOCTYPE html>\` and do not include any markdown fences (\`\`\`html) or explanations.
- Ensure the visualization is responsive and well-designed.`;

        const AI_CODE_MODIFICATION_PROMPT = `You are an expert web developer AI assistant. Your task is to modify the provided HTML code based on the user's request.
- You MUST only change the specific elements, styles, or scripts mentioned by the user.
- You MUST maintain the overall structure and functionality of the code.
- You MUST NOT alter any other part of the code.
- You MUST NOT add any new libraries (like jQuery, D3.js, etc.) unless explicitly asked by the user.
- Your output MUST be ONLY the complete, updated HTML code.
- Start your response directly with \`<!DOCTYPE html>\`.
- Do NOT include any explanations, comments, or markdown formatting (like \`\`\`html\`) around the code.`;

        const extractDataFromImage = async (base64Image, mimeType) => {
          try {
            const imagePart = { inlineData: { data: base64Image, mimeType } };
            const response = await ai.models.generateContent({
              model: 'gemini-2.5-flash',
              contents: { parts: [imagePart, { text: DATA_EXTRACTION_PROMPT }] },
              config: {
                responseMimeType: "application/json",
                responseSchema: DATA_EXTRACTION_SCHEMA,
              },
            });
            const jsonString = response.text.trim();
            return JSON.parse(jsonString);
          } catch (error) {
            console.error("Error extracting data from image:", error);
            const errorMessage = error instanceof Error ? error.message : "An unknown error occurred.";
            throw new Error(`Error calling Gemini API for data extraction: ${errorMessage}`);
          }
        };

        const generateHtmlFromData = async (editedData, base64Image, mimeType) => {
          try {
            const imagePart = { inlineData: { data: base64Image, mimeType: mimeType } };
            const textPart = { text: `${HTML_GENERATION_PROMPT}\n\nHere is the data to visualize:\n\`\`\`json\n${JSON.stringify(editedData, null, 2)}\n\`\`\`` };
            const response = await ai.models.generateContent({
              model: 'gemini-2.5-flash',
              contents: { parts: [textPart, imagePart] },
            });
            const htmlContent = response.text;
            const cleanedHtml = htmlContent.replace(/^```html\s*|```\s*$/g, '').trim();
            if (!cleanedHtml.toLowerCase().startsWith('<!doctype html')) {
                return `<!DOCTYPE html><html><head><title>Generated Content</title><style>body { font-family: sans-serif; padding: 20px; }</style></head><body><p>The model did not return valid HTML. Response:</p><pre>${cleanedHtml}</pre></body></html>`;
            }
            return cleanedHtml;
          } catch (error) {
            console.error("Error generating HTML from data:", error);
            const errorMessage = error instanceof Error ? error.message : "An unknown error occurred.";
            return `Error calling Gemini API: ${errorMessage}`;
          }
        };

        const chatWithAiToModifyCode = async (currentHtml, userRequest) => {
          try {
            const prompt = `${AI_CODE_MODIFICATION_PROMPT}\n\nHere is the user's request: "${userRequest}"\n\nHere is the current HTML code to modify:\n\`\`\`html\n${currentHtml}\n\`\`\``;
            const response = await ai.models.generateContent({
              model: 'gemini-2.5-flash',
              contents: prompt,
            });
            const modifiedHtml = response.text;
            const cleanedHtml = modifiedHtml.replace(/^```html\s*|```\s*$/g, '').trim();
            if (!cleanedHtml.toLowerCase().startsWith('<!doctype html')) {
              throw new Error("The AI did not return a valid HTML document.");
            }
            return cleanedHtml;
          } catch (error) {
            console.error("Error modifying HTML with AI:", error);
            const errorMessage = error instanceof Error ? error.message : "An unknown error occurred.";
            throw new Error(`Error calling Gemini API for code modification: ${errorMessage}`);
          }
        };

        const Icon = (props) => ( <svg {...props} xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className={`w-5 h-5 ${props.className || ''}`} > {props.children} </svg> );
        const ArrowUpTrayIcon = (props) => ( <Icon {...props}><path strokeLinecap="round" strokeLinejoin="round" d="M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5m-13.5-9L12 3m0 0 4.5 4.5M12 3v13.5" /></Icon> );
        const EyeIcon = (props) => ( <Icon {...props}><path strokeLinecap="round" strokeLinejoin="round" d="M2.036 12.322a1.012 1.012 0 0 1 0-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178Z" /><path strokeLinecap="round" strokeLinejoin="round" d="M15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" /></Icon> );
        const CodeBracketIcon = (props) => ( <Icon {...props}><path strokeLinecap="round" strokeLinejoin="round" d="M17.25 6.75 22.5 12l-5.25 5.25m-10.5 0L1.5 12l5.25-5.25m7.5-3-4.5 12" /></Icon> );
        const ArrowDownTrayIcon = (props) => ( <Icon {...props}><path strokeLinecap="round" strokeLinejoin="round" d="M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5M16.5 12 12 16.5m0 0L7.5 12m4.5 4.5V3" /></Icon> );
        const ClipboardIcon = (props) => ( <Icon {...props}><path strokeLinecap="round" strokeLinejoin="round" d="M15.666 3.888A2.25 2.25 0 0 0 13.5 2.25h-3c-1.03 0-1.9.693-2.166 1.638m7.332 0c.055.194.084.4.084.612v0a2.25 2.25 0 0 1-2.25 2.25H9.75A2.25 2.25 0 0 1 7.5 4.5v0c0-.212.03-.418.084-.612m7.332 0c.646.049 1.288.11 1.927.184 1.1.128 1.907 1.077 1.907 2.185V19.5a2.25 2.25 0 0 1-2.25 2.25H6.75A2.25 2.25 0 0 1 4.5 19.5V6.257c0-1.108.806-2.057 1.907-2.185a48.208 48.208 0 0 1 1.927-.184" /></Icon> );
        const CheckIcon = (props) => ( <Icon {...props}><path strokeLinecap="round" strokeLinejoin="round" d="m4.5 12.75 6 6 9-13.5" /></Icon> );
        const TrashIcon = (props) => ( <Icon {...props}><path strokeLinecap="round" strokeLinejoin="round" d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 0 1 3.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 0 0-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 0 0-7.5 0" /></Icon> );
        const ChartBarIcon = (props) => ( <Icon {...props}><path strokeLinecap="round" strokeLinejoin="round" d="M3 13.125C3 12.504 3.504 12 4.125 12h2.25c.621 0 1.125.504 1.125 1.125v6.75C7.5 20.496 6.996 21 6.375 21h-2.25A1.125 1.125 0 0 1 3 19.875v-6.75ZM9.75 8.625c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125v11.25c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 0 1-1.125-1.125V8.625ZM16.5 4.125c0-.621.504-1.125 1.125-1.125h2.25C20.496 3 21 3.504 21 4.125v15.75c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 0 1-1.125-1.125V4.125Z" /></Icon> );
        const SparklesIcon = (props) => ( <Icon {...props}><path strokeLinecap="round" strokeLinejoin="round" d="M9.813 15.904 9 18.75l-.813-2.846a4.5 4.5 0 0 0-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 0 0 3.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 0 0 3.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 0 0-3.09 3.09ZM18.259 8.715 18 9.75l-.259-1.035a3.375 3.375 0 0 0-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 0 0 2.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 0 0 2.456 2.456L21.75 6l-1.035.259a3.375 3.375 0 0 0-2.456 2.456ZM16.898 20.572 16.5 21.75l-.398-1.178a3.375 3.375 0 0 0-2.455-2.456L12.75 18l1.178-.398a3.375 3.375 0 0 0 2.455-2.456L16.5 14.25l.398 1.178a3.375 3.375 0 0 0 2.456 2.456L20.25 18l-1.178.398a3.375 3.375 0 0 0-2.456 2.456Z" /></Icon> );
        const PlusIcon = (props) => ( <Icon {...props}><path strokeLinecap="round" strokeLinejoin="round" d="M12 4.5v15m7.5-7.5h-15" /></Icon> );
        const XMarkIcon = (props) => ( <Icon {...props}><path strokeLinecap="round" strokeLinejoin="round" d="M6 18 18 6M6 6l12 12" /></Icon> );
        const BookmarkSquareIcon = (props) => ( <Icon {...props}><path strokeLinecap="round" strokeLinejoin="round" d="M16.5 3.75V16.5L12 14.25L7.5 16.5V3.75m9 0H7.5A2.25 2.25 0 0 0 5.25 6v13.5A2.25 2.25 0 0 0 7.5 21.75h9A2.25 2.25 0 0 0 18.75 19.5V6A2.25 2.25 0 0 0 16.5 3.75Z" /></Icon> );
        const RectangleStackIcon = (props) => ( <Icon {...props}><path strokeLinecap="round" strokeLinejoin="round" d="M6.75 7.5l3 2.25-3 2.25m4.5 0h3m-9 8.25h13.5A2.25 2.25 0 0 0 21 18V6a2.25 2.25 0 0 0-2.25-2.25H5.25A2.25 2.25 0 0 0 3 6v12a2.25 2.25 0 0 0 2.25 2.25Z" /></Icon> );
        const SlidersHorizontalIcon = (props) => ( <Icon {...props}><path strokeLinecap="round" strokeLinejoin="round" d="M10.5 6h9.75M10.5 6a1.5 1.5 0 1 1-3 0m3 0a1.5 1.5 0 1 0-3 0M3.75 6H7.5m3 12h9.75m-9.75 0a1.5 1.5 0 0 1-3 0m3 0a1.5 1.5 0 0 0-3 0m-3.75 0H7.5m9-6h3.75m-3.75 0a1.5 1.5 0 0 1-3 0m3 0a1.5 1.5 0 0 0-3 0m-9.75 0h9.75" /></Icon> );
        const ArrowTopRightOnSquareIcon = (props) => ( <Icon {...props}><path strokeLinecap="round" strokeLinejoin="round" d="M13.5 6H5.25A2.25 2.25 0 0 0 3 8.25v10.5A2.25 2.25 0 0 0 5.25 21h10.5A2.25 2.25 0 0 0 18 18.75V10.5m-10.5 6L21 3m0 0h-5.25M21 3v5.25" /></Icon> );
        const ArrowPathIcon = (props) => ( <Icon {...props}><path strokeLinecap="round" strokeLinejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0 3.181 3.183a8.25 8.25 0 0 0 11.667 0l3.181-3.183m-4.991-2.696v4.992h-4.992m0 0-3.181-3.183a8.25 8.25 0 0 1 11.667 0l3.181 3.183" /></Icon> );
        const PencilIcon = (props) => ( <Icon {...props}><path strokeLinecap="round" strokeLinejoin="round" d="m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L10.582 16.07a4.5 4.5 0 0 1-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 0 1 1.13-1.897l8.932-8.931Zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0 1 15.75 21H5.25A2.25 2.25 0 0 1 3 18.75V8.25A2.25 2.25 0 0 1 5.25 6H10" /></Icon> );
        
        const Loader = () => { return (<svg className="animate-spin h-10 w-10 text-brand-primary" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" > <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4" ></circle> <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z" ></path> </svg> ); };

        const Dropzone = ({ onFileDrop, isLoading }) => {
            const [isDragging, setIsDragging] = useState(false);
            const fileInputRef = useRef(null);
            const handleDragEnter = useCallback((e) => { e.preventDefault(); e.stopPropagation(); if (!isLoading) setIsDragging(true); }, [isLoading]);
            const handleDragLeave = useCallback((e) => { e.preventDefault(); e.stopPropagation(); setIsDragging(false); }, []);
            const handleDragOver = useCallback((e) => { e.preventDefault(); e.stopPropagation(); }, []);
            const handleDrop = useCallback((e) => { e.preventDefault(); e.stopPropagation(); setIsDragging(false); if (isLoading) return; const files = e.dataTransfer.files; if (files && files.length > 0) { onFileDrop(files[0]); } }, [isLoading, onFileDrop]);
            const handleClick = () => { if (!isLoading) { fileInputRef.current?.click(); } };
            const handleFileChange = (e) => { const files = e.target.files; if (files && files.length > 0) { onFileDrop(files[0]); } };
            const baseClasses = "w-full h-full flex flex-col items-center justify-center p-8 rounded-lg border-2 border-dashed transition-colors duration-300 cursor-pointer";
            const idleClasses = "border-brand-border hover:border-brand-primary hover:bg-brand-border/20";
            const draggingClasses = "border-brand-primary bg-brand-primary/10";
            return ( <div className={`${baseClasses} ${isDragging ? draggingClasses : idleClasses}`} onDragEnter={handleDragEnter} onDragLeave={handleDragLeave} onDragOver={handleDragOver} onDrop={handleDrop} onClick={handleClick} > <input type="file" ref={fileInputRef} onChange={handleFileChange} className="hidden" accept="image/*" disabled={isLoading} /> <div className="text-center"> <ArrowUpTrayIcon className="mx-auto h-12 w-12 text-brand-text-secondary" /> <p className="mt-4 text-lg font-semibold text-brand-text">Drop your image here</p> <p className="text-sm text-brand-text-secondary">or click to browse</p> <p className="mt-2 text-xs text-brand-text-secondary/70">Supports PNG, JPG, GIF, WEBP</p> </div> </div> );
        };

        const CodeDisplay = ({ code, onCodeChange }) => {
            const [copied, setCopied] = useState(false);
            const handleCopy = () => { navigator.clipboard.writeText(code).then(() => { setCopied(true); setTimeout(() => setCopied(false), 2000); }).catch(err => { console.error('Failed to copy text: ', err); }); };
            return ( <div className="relative h-full bg-gray-900/70 rounded-b-lg"> <button onClick={handleCopy} className="absolute top-2 right-2 p-2 rounded-md bg-brand-border/50 text-brand-text-secondary hover:bg-brand-border hover:text-brand-text transition-colors z-10" aria-label="Copy code" > {copied ? <CheckIcon /> : <ClipboardIcon />} </button> <textarea value={code} onChange={(e) => onCodeChange(e.target.value)} spellCheck="false" aria-label="HTML Code Editor" className="w-full h-full resize-none border-0 bg-transparent p-4 font-mono text-sm text-white focus:ring-0" /> </div> );
        };

        const CustomizationPanel = ({ data, onDataChange, onApplyChanges, isGenerating, hasAppliedChanges, }) => {
            const handleFieldChange = (field, value) => { onDataChange({ ...data, [field]: value }); };
            const handleDataChange = (rowIndex, field, value, valueIndex) => { const newData = [...data.data]; if (field === 'label') { newData[rowIndex].label = value; } else if (typeof valueIndex !== 'undefined') { newData[rowIndex].values[valueIndex] = parseFloat(value) || 0; } onDataChange({ ...data, data: newData }); };
            const handleAddRow = () => { const numValues = data.seriesLabels?.length || 1; const newRow = { label: 'New Label', values: Array(numValues).fill(0) }; onDataChange({ ...data, data: [...data.data, newRow] }); };
            const handleRemoveRow = (rowIndex) => { const newData = data.data.filter((_, i) => i !== rowIndex); onDataChange({ ...data, data: newData }); };
            const handleColorChange = (index, newColor) => { const newColors = [...data.colors]; newColors[index] = newColor; onDataChange({ ...data, colors: newColors }); };
            const handleAddColor = () => { const newColors = [...data.colors, '#CCCCCC']; onDataChange({ ...data, colors: newColors }); };
            const handleRemoveColor = (index) => { const newColors = data.colors.filter((_, i) => i !== index); onDataChange({ ...data, colors: newColors }); };
            return ( <div className="flex flex-col h-full"> <div className="space-y-4 flex-grow overflow-y-auto p-4 pr-2"> <fieldset className="space-y-2" disabled={isGenerating}> <legend className="text-sm font-medium text-brand-text-secondary mb-1">General</legend> <div> <label htmlFor="title-editor" className="block text-xs font-medium text-brand-text-secondary/80 mb-1">Title</label> <input id="title-editor" type="text" value={data.title} onChange={(e) => handleFieldChange('title', e.target.value)} className="w-full bg-brand-bg border border-brand-border rounded-md px-2 py-1.5 text-sm focus:ring-1 focus:ring-brand-primary focus:border-brand-primary" /> </div> <div> <label htmlFor="chart-type-editor" className="block text-xs font-medium text-brand-text-secondary/80 mb-1">Chart Type</label> <select id="chart-type-editor" value={data.chartType} onChange={(e) => handleFieldChange('chartType', e.target.value)} className="w-full bg-brand-bg border border-brand-border rounded-md px-2 py-1.5 text-sm focus:ring-1 focus:ring-brand-primary focus:border-brand-primary" > <option value="bar">Bar Chart</option> <option value="line">Line Chart</option> <option value="pie">Pie Chart</option> <option value="table">Table</option> </select> </div> </fieldset> <fieldset className="space-y-2" disabled={isGenerating}> <legend className="text-sm font-medium text-brand-text-secondary mb-1">Color Palette</legend> <div className="flex flex-wrap gap-2"> {data.colors.map((color, index) => ( <div key={index} className="flex items-center space-x-1.5 bg-brand-bg p-1 pr-2 border border-brand-border rounded-md"> <input type="color" value={color} onChange={(e) => handleColorChange(index, e.target.value)} className="w-5 h-5 rounded border-none bg-transparent cursor-pointer" /> <span className="font-mono text-xs text-brand-text-secondary">{color.toUpperCase()}</span> <button onClick={() => handleRemoveColor(index)} className="text-brand-text-secondary hover:text-red-400"><TrashIcon className="w-3.5 h-3.5"/></button> </div> ))} <button onClick={handleAddColor} className="flex items-center space-x-1 text-sm text-brand-text-secondary hover:text-brand-text bg-brand-bg px-2 py-1 border border-brand-border rounded-md"><PlusIcon className="w-4 h-4" /><span>Add</span></button> </div> </fieldset> <fieldset disabled={isGenerating}> <legend className="text-sm font-medium text-brand-text-secondary mb-1">Data</legend> <div className="space-y-2"> {data.data.map((row, rowIndex) => ( <div key={rowIndex} className="grid grid-cols-[1fr_1fr_auto] gap-2 items-center bg-brand-bg p-1.5 border border-brand-border rounded-md"> <input type="text" value={row.label} onChange={e => handleDataChange(rowIndex, 'label', e.target.value)} placeholder="Label" className="bg-gray-800/60 border border-brand-border/50 rounded px-2 py-1 text-sm w-full"/> <div className="flex items-center gap-2"> {row.values.map((val, valIndex) => ( <input key={valIndex} type="number" value={val} onChange={e => handleDataChange(rowIndex, 'value', e.target.value, valIndex)} className="bg-gray-800/60 border border-brand-border/50 rounded px-2 py-1 text-sm w-full"/> ))} </div> <button onClick={() => handleRemoveRow(rowIndex)} className="text-brand-text-secondary hover:text-red-400 px-1"><TrashIcon /></button> </div> ))} </div> <button onClick={handleAddRow} className="mt-2 flex items-center space-x-1.5 text-sm text-brand-text-secondary hover:text-brand-text bg-brand-bg px-2.5 py-1.5 border border-brand-border rounded-md w-full justify-center"><PlusIcon className="w-4 h-4"/><span>Add Data Row</span></button> </fieldset> </div> <div className="flex-shrink-0 p-3 border-t border-brand-border"> <button onClick={onApplyChanges} disabled={isGenerating || hasAppliedChanges} className="w-full flex items-center justify-center space-x-2 bg-brand-primary text-white px-4 py-2 rounded-md font-medium hover:bg-brand-primary-hover transition-colors disabled:bg-brand-border disabled:text-brand-text-secondary disabled:cursor-not-allowed" > <ArrowPathIcon className={isGenerating ? 'animate-spin' : ''} /> <span>{isGenerating ? 'Applying...' : 'Apply & Regenerate Preview'}</span> </button> </div> </div> );
        };

        const GalleryItemCard = ({ item, isSelected, onSelect, onDelete, onLoad, onRename }) => {
            const [isRenaming, setIsRenaming] = useState(false);
            const [title, setTitle] = useState(item.title);
            const inputRef = useRef(null);
            useEffect(() => { if (isRenaming) { inputRef.current?.focus(); inputRef.current?.select(); } }, [isRenaming]);
            const handleRename = () => { if (title.trim() && title.trim() !== item.title) { onRename(item.id, title.trim()); } else { setTitle(item.title); } setIsRenaming(false); };
            const handleDelete = (e) => { e.stopPropagation(); onDelete(item.id); };
            const handleMainClick = () => { if (!isRenaming) { onLoad(item); } };
            const handleDoubleClick = (e) => { e.stopPropagation(); setIsRenaming(true); };
            const handleKeydown = (e) => { if (e.key === ' ' || e.key === 'Enter') { e.preventDefault(); handleMainClick(); } }
            return ( <div className="relative group bg-brand-surface border border-brand-border rounded-lg overflow-hidden transition-all duration-300 hover:border-brand-primary hover:shadow-lg hover:shadow-brand-primary/10 focus-within:border-brand-primary cursor-pointer" onClick={handleMainClick} onKeyDown={handleKeydown} role="button" tabIndex={0} aria-label={`Load ${item.title}`} > <div className="absolute top-2 right-2 z-10 flex items-center gap-2"> <input type="checkbox" checked={isSelected} onChange={(e) => onSelect(item.id, e.target.checked)} className="form-checkbox h-5 w-5 rounded bg-brand-bg border-brand-border text-brand-primary focus:ring-brand-primary cursor-pointer" onClick={(e) => e.stopPropagation()} aria-label={`Select ${item.title}`} /> <button onClick={handleDelete} className="p-1.5 bg-red-600/80 text-white rounded-full opacity-0 group-hover:opacity-100 focus:opacity-100 hover:bg-red-600 transition-opacity" aria-label={`Delete ${item.title}`} > <TrashIcon className="w-4 h-4" /> </button> </div> <div> <img src={`data:image/png;base64,${item.originalImageBase64}`} alt={item.title} className="w-full h-40 object-cover bg-gray-900/50" loading="lazy" /> <div className="p-3" onDoubleClick={handleDoubleClick}> {isRenaming ? ( <input ref={inputRef} type="text" value={title} onChange={(e) => setTitle(e.target.value)} onBlur={handleRename} onKeyDown={(e) => { if (e.key === 'Enter') handleRename(); if (e.key === 'Escape') setIsRenaming(false); }} onClick={(e) => e.stopPropagation()} className="w-full bg-brand-bg border border-brand-primary rounded-md px-2 py-1 text-sm focus:ring-1 focus:ring-brand-primary" /> ) : ( <h3 className="font-semibold text-brand-text truncate flex items-center" title={item.title}> <span className="truncate">{item.title}</span> <PencilIcon className="w-3 h-3 ml-2 text-transparent group-hover:text-brand-text-secondary transition-colors" /> </h3> )} <p className="text-xs text-brand-text-secondary mt-1"> {new Date(item.createdAt).toLocaleDateString()} </p> </div> </div> {isSelected && <div className="absolute inset-0 border-2 border-brand-primary rounded-lg pointer-events-none" aria-hidden="true" />} </div> );
        };

        const Gallery = ({ items, isOpen, onClose, onDelete, onCombine, onLoad, onRename }) => {
            const [sortBy, setSortBy] = useState('date-desc');
            const [selectedIds, setSelectedIds] = useState(new Set());
            const handleSelect = (id, isSelected) => { setSelectedIds(prev => { const newSet = new Set(prev); if (isSelected) { newSet.add(id); } else { newSet.delete(id); } return newSet; }); };
            const handleCombineClick = () => { onCombine(selectedIds); setSelectedIds(new Set()); onClose(); };
            const handleClose = () => { setSelectedIds(new Set()); onClose(); }
            const sortedItems = useMemo(() => { return [...items].sort((a, b) => { switch (sortBy) { case 'date-asc': return new Date(a.createdAt).getTime() - new Date(b.createdAt).getTime(); case 'title-asc': return a.title.localeCompare(b.title); case 'title-desc': return b.title.localeCompare(a.title); case 'date-desc': default: return new Date(b.createdAt).getTime() - new Date(a.createdAt).getTime(); } }); }, [items, sortBy]);
            if (!isOpen) return null;
            return ( <div className="fixed inset-0 bg-brand-bg/80 backdrop-blur-sm z-50 flex items-center justify-center p-4" aria-modal="true" role="dialog" onClick={handleClose}> <div className="bg-brand-surface w-full h-full max-w-6xl flex flex-col rounded-lg shadow-2xl border border-brand-border" onClick={e => e.stopPropagation()}> <header className="flex-shrink-0 flex items-center justify-between p-4 border-b border-brand-border"> <h2 className="text-xl font-bold text-brand-text">My Gallery</h2> <div className="flex items-center gap-4"> <div className="flex items-center gap-2"> <label htmlFor="sort-by" className="text-sm text-brand-text-secondary">Sort by:</label> <select id="sort-by" value={sortBy} onChange={e => setSortBy(e.target.value)} className="bg-brand-bg border border-brand-border rounded-md px-2 py-1 text-sm focus:ring-1 focus:ring-brand-primary focus:border-brand-primary" > <option value="date-desc">Newest First</option> <option value="date-asc">Oldest First</option> <option value="title-asc">Title (A-Z)</option> <option value="title-desc">Title (Z-A)</option> </select> </div> <button onClick={handleClose} className="text-brand-text-secondary hover:text-brand-text"> <XMarkIcon className="w-6 h-6" /> </button> </div> </header> <main className="flex-grow p-4 overflow-y-auto"> {items.length === 0 ? ( <div className="h-full flex flex-col items-center justify-center text-brand-text-secondary"> <RectangleStackIcon className="w-16 h-16 mb-4" /> <h3 className="text-lg font-semibold">Your gallery is empty</h3> <p>Generate visualizations and save them to see them here.</p> </div> ) : ( <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4"> {sortedItems.map(item => ( <GalleryItemCard key={item.id} item={item} isSelected={selectedIds.has(item.id)} onSelect={handleSelect} onDelete={onDelete} onLoad={onLoad} onRename={onRename} /> ))} </div> )} </main> {items.length > 0 && ( <footer className="flex-shrink-0 p-4 border-t border-brand-border flex items-center justify-end"> <button onClick={handleCombineClick} disabled={selectedIds.size === 0} className="flex items-center space-x-2 bg-brand-primary text-white px-4 py-2 rounded-md font-medium hover:bg-brand-primary-hover transition-colors disabled:bg-brand-border disabled:text-brand-text-secondary disabled:cursor-not-allowed" > <ArrowDownTrayIcon /> <span>Save & Download ({selectedIds.size})</span> </button> </footer> )} </div> </div> );
        };

        const AiChatPanel = ({ history, onSendMessage, isLoading }) => {
            const [input, setInput] = useState('');
            const messagesEndRef = useRef(null);
            const scrollToBottom = () => { messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' }); };
            useEffect(() => { scrollToBottom(); }, [history, isLoading]);
            const handleSubmit = (e) => { e.preventDefault(); if (input.trim() && !isLoading) { onSendMessage(input); setInput(''); } };
            return ( <div className="h-full flex flex-col"> <div className="flex-grow p-4 space-y-4 overflow-y-auto min-h-0"> {history.map((msg, index) => ( <div key={index} className={`flex items-end gap-2 ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`}> {msg.role === 'assistant' && ( <div className="flex-shrink-0 w-8 h-8 rounded-full bg-brand-primary flex items-center justify-center"> <SparklesIcon className="w-5 h-5 text-white" /> </div> )} <div className={`max-w-xs md:max-w-md lg:max-w-lg px-4 py-2 rounded-lg ${ msg.role === 'user' ? 'bg-brand-primary text-white' : 'bg-brand-surface text-brand-text border border-brand-border' }`} > <p className="text-sm whitespace-pre-wrap">{msg.content}</p> </div> </div> ))} {isLoading && ( <div className="flex items-end gap-2 justify-start"> <div className="flex-shrink-0 w-8 h-8 rounded-full bg-brand-primary flex items-center justify-center"> <SparklesIcon className="w-5 h-5 text-white" /> </div> <div className="max-w-xs md:max-w-md lg:max-w-lg px-4 py-2 rounded-lg bg-brand-surface border border-brand-border flex items-center"> <Loader /> <span className="text-sm ml-2 text-brand-text-secondary">Thinking...</span> </div> </div> )} <div ref={messagesEndRef} /> </div> <div className="flex-shrink-0 p-2 border-t border-brand-border"> <form onSubmit={handleSubmit} className="flex items-center gap-2"> <textarea value={input} onChange={(e) => setInput(e.target.value)} onKeyDown={(e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); handleSubmit(e); } }} placeholder="e.g., 'Change the bar color to green'" rows={1} className="flex-grow bg-brand-bg border border-brand-border rounded-md px-3 py-2 text-sm focus:ring-1 focus:ring-brand-primary focus:border-brand-primary resize-none text-brand-text" disabled={isLoading} /> <button type="submit" disabled={isLoading || !input.trim()} className="bg-brand-primary text-white px-4 py-2 rounded-md font-medium hover:bg-brand-primary-hover transition-colors disabled:bg-brand-border disabled:text-brand-text-secondary disabled:cursor-not-allowed" > Send </button> </form> </div> </div> );
        };
        
        const TabButton = ({ icon, label, isActive, onClick }) => ( <button onClick={onClick} className={`flex items-center space-x-2 px-3 py-1.5 rounded-md text-sm font-medium transition-colors ${ isActive ? 'bg-brand-primary text-white' : 'text-brand-text-secondary hover:bg-brand-border/50 hover:text-brand-text' }`} > {icon} <span className="hidden sm:inline">{label}</span> </button> );

        const App = () => {
            const [step, setStep] = useState('initial');
            const [imageFile, setImageFile] = useState(null);
            const [base64Image, setBase64Image] = useState(null);
            const [imageUrl, setImageUrl] = useState(null);
            const [generatedHtml, setGeneratedHtml] = useState(null);
            const [error, setError] = useState(null);
            const [activeTab, setActiveTab] = useState('preview');
            const [leftPanelView, setLeftPanelView] = useState('customize');
            const [editedData, setEditedData] = useState(null);
            const [stagedEditedData, setStagedEditedData] = useState(null);
            const [isProcessing, setIsProcessing] = useState(false);
            const [isPreviewLoading, setIsPreviewLoading] = useState(false);
            const [notification, setNotification] = useState(null);
            const [chatHistory, setChatHistory] = useState([]);
            const [isAiChatLoading, setIsAiChatLoading] = useState(false);
            const [gallery, setGallery] = useState([]);
            const [isGalleryOpen, setIsGalleryOpen] = useState(false);
            const [currentGalleryItemId, setCurrentGalleryItemId] = useState(null);

            const getCombinedItemPlaceholderB64 = () => { const svgString = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="#a0a0a4" class="w-24 h-24"> <path stroke-linecap="round" stroke-linejoin="round" d="M6.75 7.5l3 2.25-3 2.25m4.5 0h3m-9 8.25h13.5A2.25 2.25 0 0 0 21 18V6a2.25 2.25 0 0 0-2.25-2.25H5.25A2.25 2.25 0 0 0 3 6v12a2.25 2.25 0 0 0 2.25 2.25Z" /> </svg>`; return btoa(svgString); };
            
            useEffect(() => { try { const savedGallery = localStorage.getItem('data-viz-gallery'); if (savedGallery) { setGallery(JSON.parse(savedGallery)); } } catch (e) { console.error("Failed to load gallery from localStorage", e); } }, []);
            useEffect(() => { localStorage.setItem('data-viz-gallery', JSON.stringify(gallery)); }, [gallery]);
            useEffect(() => { if (notification) { const timer = setTimeout(() => setNotification(null), 3000); return () => clearTimeout(timer); } }, [notification]);

            const resetState = useCallback(() => { setStep('initial'); setImageFile(null); setBase64Image(null); if (imageUrl) { URL.revokeObjectURL(imageUrl); } setImageUrl(null); setGeneratedHtml(null); setError(null); setActiveTab('preview'); setLeftPanelView('customize'); setEditedData(null); setStagedEditedData(null); setCurrentGalleryItemId(null); setIsProcessing(false); setIsPreviewLoading(false); setChatHistory([]); setIsAiChatLoading(false); }, [imageUrl]);
            
            const handleFileDrop = useCallback(async (file) => {
                resetState();
                if (!file.type.startsWith('image/')) { setError("Please drop an image file (PNG, JPG, etc.)."); setStep('error'); return; }
                setStep('extracting'); setIsProcessing(true); setImageFile(file); const localImageUrl = URL.createObjectURL(file); setImageUrl(localImageUrl);
                try {
                    const b64 = await fileToBase64(file); setBase64Image(b64); const extractedResult = await extractDataFromImage(b64, file.type);
                    setEditedData(extractedResult); setStagedEditedData(extractedResult); setStep('live_editing');
                } catch (e) { const errorMessage = e instanceof Error ? e.message : "An unknown error occurred during data extraction."; console.error(e); setError(errorMessage); setStep('error'); } finally { setIsProcessing(false); }
            }, [resetState]);
            
            useEffect(() => { const regenerateVisualization = async () => { if (!editedData || !base64Image || !imageFile) return; setIsPreviewLoading(true); try { const html = await generateHtmlFromData(editedData, base64Image, imageFile.type); if (html.toLowerCase().includes("error calling gemini api") || html.toLowerCase().includes("an unknown error occurred")) { setError(html.replace(/<\/?div>|<\/?p>/g, '')); setGeneratedHtml(null); } else { if (generatedHtml === null) { setChatHistory([{ role: 'assistant', content: "I've generated your visualization! You can now customize its data and appearance." }]); } setGeneratedHtml(html); setError(null); } } catch (e) { const errorMessage = e instanceof Error ? e.message : "An unknown error occurred during visualization generation."; console.error(e); setError(errorMessage); setGeneratedHtml(null); } finally { setIsPreviewLoading(false); } }; regenerateVisualization(); }, [editedData, base64Image, imageFile]);
            
            const handleApplyCustomizationChanges = () => { if (stagedEditedData) { setEditedData(stagedEditedData); setNotification('Applying changes...'); } };
            
            const handleDownload = () => { if (!generatedHtml) return; const blob = new Blob([generatedHtml], { type: 'text/html' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `${editedData?.title || 'visualization'}.html`; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url); };
            
            const handleOpenInNewTab = () => { if (!generatedHtml) return; const blob = new Blob([generatedHtml], { type: 'text/html' }); const url = URL.createObjectURL(blob); window.open(url, '_blank', 'noopener,noreferrer'); };
            
            const handleSaveOrUpdateGallery = useCallback(() => { if (!generatedHtml || !stagedEditedData || !base64Image) return; setEditedData(stagedEditedData); if (currentGalleryItemId) { setGallery(prev => prev.map(item => item.id === currentGalleryItemId ? { ...item, title: stagedEditedData.title, generatedHtml, editedData: stagedEditedData } : item )); setNotification('Visualization updated in gallery!'); } else { const newItem = { id: `item-${Date.now()}`, title: stagedEditedData.title || 'Untitled Visualization', generatedHtml, originalImageBase64: base64Image, createdAt: new Date().toISOString(), editedData: stagedEditedData, }; setGallery(prev => [newItem, ...prev]); setCurrentGalleryItemId(newItem.id); setNotification('Saved to gallery!'); } }, [generatedHtml, stagedEditedData, base64Image, currentGalleryItemId]);
            
            const handleDeleteFromGallery = (id) => { setGallery(prev => prev.filter(item => item.id !== id)); setNotification('Item deleted from gallery.'); };
            
            const handleRenameItem = (id, newTitle) => { setGallery(prev => prev.map(item => item.id === id ? { ...item, title: newTitle } : item )); if (id === currentGalleryItemId && stagedEditedData) { setStagedEditedData(prev => prev ? { ...prev, title: newTitle } : null); if (editedData) { setEditedData(prev => prev ? { ...prev, title: newTitle } : null); } } setNotification('Item renamed!'); };
            
            const handleLoadFromGallery = useCallback(async (item) => { setIsGalleryOpen(false); resetState(); setStep('extracting'); setIsProcessing(true); await new Promise(resolve => setTimeout(resolve, 200)); try { if (item.isCombined || !item.editedData) { setGeneratedHtml(item.generatedHtml); setBase64Image(item.originalImageBase64); setImageUrl(`data:image/svg+xml;base64,${item.originalImageBase64}`); setEditedData(null); setStagedEditedData(null); setChatHistory([{ role: 'assistant', content: `Loaded "${item.title}". This is a combined dashboard and cannot be edited directly, but you can use the AI Chat to make changes.` }]); } else { const mimeType = 'image/png'; const imageUrl = `data:${mimeType};base64,${item.originalImageBase64}`; const fakeFile = new File([], "loaded.png", { type: mimeType }); setImageFile(fakeFile); setImageUrl(imageUrl); setBase64Image(item.originalImageBase64); setGeneratedHtml(item.generatedHtml); setEditedData(item.editedData); setStagedEditedData(item.editedData); setChatHistory([{ role: 'assistant', content: `Loaded "${item.title}" from your gallery. You can now modify it.` }]); } setCurrentGalleryItemId(item.id); setStep('live_editing'); setActiveTab('preview'); setLeftPanelView('customize'); } catch (e) { const errorMessage = e instanceof Error ? e.message : "An unknown error occurred while loading the item."; console.error(e); setError(errorMessage); setStep('error'); } finally { setIsProcessing(false); } }, [resetState]);
            
            const handleCombineItems = (selectedIds) => { const itemsToCombine = gallery.filter(item => selectedIds.has(item.id)).sort((a, b) => new Date(a.createdAt).getTime() - new Date(b.createdAt).getTime()); if (itemsToCombine.length === 0) return; const allStyles = new Map(); const allBodySections = []; const allScripts = []; const chartJsCdnUrl = "https://cdn.jsdelivr.net/npm/chart.js"; let chartJsNeeded = false; itemsToCombine.forEach((item, index) => { const uniqueSuffix = `${item.id.replace(/\W/g, '')}-${index}`; const html = item.generatedHtml; const styleMatch = html.match(/<style>([\s\S]*?)<\/style>/i); if (styleMatch?.[1]) { const styleContent = styleMatch[1].trim(); if (!allStyles.has(styleContent)) { allStyles.set(styleContent, styleContent); } } let bodyContent = html.match(/<body[^>]*>([\s\S]*)<\/body>/i)?.[1] || ''; const scriptMatches = [...html.matchAll(/<script([^>]*)>([\s\S]*?)<\/script>/gi)]; let canvasIdUpdated = false; bodyContent = bodyContent.replace(/<canvas id=["']([^"']+)["']/g, (match, originalId) => { const newId = `${originalId}-${uniqueSuffix}`; canvasIdUpdated = true; return `<canvas id="${newId}"`; }); scriptMatches.forEach(scriptMatch => { const scriptAttrs = scriptMatch[1]; let scriptContent = scriptMatch[2]; if (scriptAttrs.includes('src')) { if (scriptAttrs.includes('chart.js')) { chartJsNeeded = true; } return; } if (canvasIdUpdated) { scriptContent = scriptContent.replace(/getElementById\((['"])([^'"]+)\1\)/g, (match, quote, originalId) => { const newId = `${originalId}-${uniqueSuffix}`; return `getElementById(${quote}${newId}${quote})`; }); } allScripts.push(`(function() {\n    try {\n        ${scriptContent}\n    } catch (e) {\n        console.error("Error in chart script for item ${item.id}:", e);\n    }\n})();`); }); allBodySections.push({ title: item.title, content: bodyContent }); }); const combinedStyles = Array.from(allStyles.values()).join('\n\n'); const combinedBody = allBodySections.map(section => `<section class="visualization-container"><h2 class="visualization-title">${section.title}</h2><div class="visualization-content">${section.content}</div></section>`).join(''); const combinedScripts = allScripts.join('\n\n'); const chartJsScriptTag = chartJsNeeded ? `<script src="${chartJsCdnUrl}"><\/script>` : ''; const combinedHtml = `<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>Combined Dashboard</title>${chartJsScriptTag}<style>body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; background-color: #f0f2f5; color: #1a1a1a; } main { display: flex; flex-wrap: wrap; justify-content: center; gap: 2rem; padding: 2rem; } .visualization-container { padding: 2rem; background-color: white; border-radius: 12px; box-shadow: 0 6px 12px rgba(0,0,0,0.08); flex: 1 1 550px; min-width: 320px; max-width: 95vw; } .visualization-title { text-align: center; color: #333; margin-top: 0; margin-bottom: 1.5rem; font-size: 1.5em; } .visualization-content { position: relative; min-height: 400px; display: flex; align-items: center; justify-content: center; } canvas { max-width: 100%; height: auto !important; }</style><style>${combinedStyles}</style></head><body><main>${combinedBody}</main><script>${combinedScripts}<\/script></body></html>`; const newCombinedItem = { id: `combined-${Date.now()}`, title: `Combined Dashboard (${itemsToCombine.length} items)`, generatedHtml: combinedHtml, originalImageBase64: getCombinedItemPlaceholderB64(), createdAt: new Date().toISOString(), editedData: null, isCombined: true, }; setGallery(prev => [newCombinedItem, ...prev]); const blob = new Blob([combinedHtml], { type: 'text/html' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = 'combined_dashboard.html'; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url); setNotification('Dashboard saved to gallery & downloaded!'); };

            const handleSendMessage = async (message) => { if (!message.trim() || !generatedHtml || isAiChatLoading) return; const newUserMessage = { role: 'user', content: message }; setChatHistory(prev => [...prev, newUserMessage]); setIsAiChatLoading(true); setActiveTab('preview'); try { const updatedHtml = await chatWithAiToModifyCode(generatedHtml, message); setGeneratedHtml(updatedHtml); const assistantMessage = { role: 'assistant', content: "I've updated the visualization based on your request." }; setChatHistory(prev => [...prev, assistantMessage]); } catch (e) { const errorMessage = e instanceof Error ? e.message : "An unknown error occurred."; console.error(e); const assistantErrorMessage = { role: 'assistant', content: `I'm sorry, I encountered an error and couldn't apply your changes.\n\nDetails: ${errorMessage}` }; setChatHistory(prev => [...prev, assistantErrorMessage]); } finally { setIsAiChatLoading(false); } };
            
            const hasUnsavedChanges = useMemo(() => { if (!currentGalleryItemId || !stagedEditedData) return false; const currentItemInGallery = gallery.find(item => item.id === currentGalleryItemId); if (!currentItemInGallery?.editedData) return false; return JSON.stringify(stagedEditedData) !== JSON.stringify(currentItemInGallery.editedData); }, [stagedEditedData, currentGalleryItemId, gallery]);
            const hasAppliedChanges = useMemo(() => { return JSON.stringify(editedData) === JSON.stringify(stagedEditedData); }, [editedData, stagedEditedData]);

            const renderOutput = () => { const showInitialLoader = (step === 'live_editing' && !generatedHtml && isPreviewLoading && !error); if (showInitialLoader) { return <div className="w-full h-full flex flex-col items-center justify-center"><Loader /><p className="mt-4 text-brand-text-secondary">Generating initial visualization...</p></div>; } if (generatedHtml) { const isSaveable = stagedEditedData && !stagedEditedData.title.startsWith("Combined Dashboard"); const saveButtonText = currentGalleryItemId ? (hasUnsavedChanges ? "Update" : "Saved") : "Save"; const isSaveButtonDisabled = !isSaveable || (!!currentGalleryItemId && !hasUnsavedChanges); return ( <div className="relative flex flex-col h-full bg-brand-surface rounded-lg"> <div className="flex-shrink-0 p-2 border-b border-brand-border"> <div className="flex items-center justify-between"> <div className="flex items-center space-x-1 bg-gray-900/50 p-1 rounded-md"> <TabButton icon={<EyeIcon />} label="Preview" isActive={activeTab === 'preview'} onClick={() => setActiveTab('preview')} /> <TabButton icon={<CodeBracketIcon />} label="Code" isActive={activeTab === 'code'} onClick={() => setActiveTab('code')} /> </div> <div className="flex items-center space-x-2"> <button onClick={handleOpenInNewTab} className="p-1.5 rounded-md text-sm font-medium text-brand-text-secondary hover:bg-brand-border hover:text-brand-text transition-colors" title="Open preview in new tab" > <ArrowTopRightOnSquareIcon /> </button> <button onClick={handleSaveOrUpdateGallery} disabled={isSaveButtonDisabled} className="flex items-center space-x-2 bg-gray-600 text-white px-3 py-1.5 rounded-md text-sm font-medium hover:bg-gray-500 transition-colors disabled:bg-brand-border disabled:text-brand-text-secondary disabled:cursor-not-allowed"> <BookmarkSquareIcon /> <span>{saveButtonText}</span> </button> <button onClick={handleDownload} className="flex items-center space-x-2 bg-brand-primary text-white px-3 py-1.5 rounded-md text-sm font-medium hover:bg-brand-primary-hover transition-colors"> <ArrowDownTrayIcon /> <span>Download</span> </button> </div> </div> </div> <div className="flex-grow min-h-0"> {activeTab === 'preview' ? ( <iframe srcDoc={generatedHtml} title="Generated HTML Preview" className="w-full h-full border-0" sandbox="allow-scripts allow-same-origin" /> ) : ( <CodeDisplay code={generatedHtml} onCodeChange={setGeneratedHtml} /> )} </div> {isPreviewLoading && ( <div className="absolute inset-0 bg-brand-surface/70 backdrop-blur-sm flex flex-col items-center justify-center z-10 transition-opacity"> <Loader /> <p className="mt-4 text-brand-text-secondary">Updating preview...</p> </div> )} </div> ); } const hasError = (step === 'error' || step === 'live_editing') && error; if (hasError) { return ( <div className="w-full h-full flex flex-col items-center justify-center p-4"> <div className="bg-red-900/20 border border-red-500 text-red-300 p-4 rounded-lg text-center max-w-md"> <h3 className="font-bold mb-2 text-lg">An Error Occurred</h3> <p className="text-sm">{error}</p> </div> </div> ); } return ( <div className="w-full h-full flex flex-col items-center justify-center text-center text-brand-text-secondary p-4"> <ChartBarIcon className="w-16 h-16 mb-4" /> <h3 className="font-bold text-lg text-brand-text">Output Panel</h3> <p>Your interactive visualization will appear here.</p> </div> ); };

            const renderLeftPanel = () => { if (step === 'initial') { return <Dropzone onFileDrop={handleFileDrop} isLoading={isProcessing} />; } if (step === 'extracting') { return ( <div className="w-full h-full flex flex-col items-center justify-center"> <Loader /> <p className="mt-4 text-brand-text-secondary">Extracting data from image...</p> </div> ) } if (imageUrl && (step === 'live_editing' || step === 'error')) { return ( <div className="w-full h-full flex flex-col space-y-4"> <div className="relative flex-shrink-0"> <img src={imageUrl} alt="Uploaded chart" className="max-w-full max-h-[25vh] object-contain rounded-md mx-auto bg-gray-900/20" /> <button onClick={resetState} className="absolute top-2 right-2 flex items-center space-x-2 bg-red-600/80 text-white px-3 py-1.5 rounded-md font-medium hover:bg-red-600 transition-colors text-sm z-10"> <TrashIcon /> </button> </div> <div className="rounded-lg flex-grow flex flex-col min-h-0"> <div className="flex-shrink-0 flex items-center justify-between p-3 bg-brand-surface rounded-t-lg border-b border-brand-border"> <h3 className="text-lg font-semibold text-brand-text"> {leftPanelView === 'customize' ? (stagedEditedData ? 'Customize Visualization' : 'Dashboard View') : 'AI Assistant'} </h3> <div className="flex items-center space-x-1 bg-gray-900/50 p-1 rounded-md"> <TabButton icon={<SlidersHorizontalIcon />} label="Customize" isActive={leftPanelView === 'customize'} onClick={() => setLeftPanelView('customize')} /> <TabButton icon={<SparklesIcon />} label="AI Chat" isActive={leftPanelView === 'ai-chat'} onClick={() => setLeftPanelView('ai-chat')} /> </div> </div> <div className="flex-grow min-h-0 bg-brand-surface rounded-b-lg"> {leftPanelView === 'customize' ? ( stagedEditedData ? ( <CustomizationPanel data={stagedEditedData} onDataChange={setStagedEditedData} onApplyChanges={handleApplyCustomizationChanges} isGenerating={isPreviewLoading} hasAppliedChanges={hasAppliedChanges} /> ) : ( <div className="h-full flex flex-col items-center justify-center p-4 text-center text-brand-text-secondary"> <RectangleStackIcon className="w-12 h-12 mx-auto mb-4" /> <h4 className="font-semibold text-brand-text">Combined Dashboard</h4> <p className="text-sm mt-1">This item cannot be edited directly. You can use the "AI Chat" tab to make modifications, or use the output panel to download or open it in a new tab.</p> </div> ) ) : ( <AiChatPanel history={chatHistory} onSendMessage={handleSendMessage} isLoading={isAiChatLoading} /> )} </div> </div> </div> ); } return <Dropzone onFileDrop={handleFileDrop} isLoading={isProcessing} />; };

            return (
                <div className="min-h-screen flex flex-col p-4 md:p-6 lg:p-8 space-y-4">
                    <header className="flex items-center justify-between">
                        <div className="text-left">
                            <h1 className="text-3xl sm:text-4xl font-bold tracking-tight">Data Visualizer AI</h1>
                            <p className="text-brand-text-secondary mt-2 text-md sm:text-lg">Transform images into editable, interactive web dashboards.</p>
                        </div>
                        <button onClick={() => setIsGalleryOpen(true)} className="flex items-center space-x-2 bg-brand-surface text-brand-text px-4 py-2 rounded-lg font-medium hover:bg-brand-border transition-colors border border-brand-border" > <RectangleStackIcon /> <span>My Gallery ({gallery.length})</span> </button>
                    </header>
                    <main className="flex-grow grid grid-cols-1 lg:grid-cols-2 gap-6 min-h-0">
                        <div className="bg-brand-surface rounded-lg p-4 flex flex-col min-h-[50vh] lg:min-h-0"> {renderLeftPanel()} </div>
                        <div className="min-h-[50vh] lg:min-h-0"> {renderOutput()} </div>
                    </main>
                    <Gallery isOpen={isGalleryOpen} items={gallery} onClose={() => setIsGalleryOpen(false)} onDelete={handleDeleteFromGallery} onCombine={handleCombineItems} onLoad={handleLoadFromGallery} onRename={handleRenameItem} />
                    {notification && ( <div className="fixed bottom-5 right-5 bg-brand-primary text-white px-4 py-2 rounded-lg shadow-lg animate-bounce"> {notification} </div> )}
                </div>
            );
        };
        
        const rootElement = document.getElementById('root');
        if (!rootElement) {
          throw new Error("Could not find root element to mount to");
        }
        const root = ReactDOM.createRoot(rootElement);
        root.render(<App />);

    </script>
  </body>
</html>
